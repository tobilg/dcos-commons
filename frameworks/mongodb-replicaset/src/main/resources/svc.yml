name: "mongodb-replicaset"
principal: "mongodb-replicaset-principal"
zookeeper: master.mesos:2181
api-port: {{PORT0}}
pods:
  mongodb:
    count: {{MONGODB_COUNT}}
    resource-sets:
      mongodb-resources:
        cpus: {{MONGODB_CPUS}}
        memory: {{MONGODB_MEM}}
        ports:
          - name: "mongodb-port"
            port: 27017
            vip:
              prefix: "mongodb-replicaset"
              port: 27017
        volumes:
          - path: "mongodb-replicaset"
            type: ROOT
            size: {{MONGODB_DISK}}
    tasks:
      server:
        resource-set: mongodb-resources
        goal: RUNNING
        cmd: "env && exec $MESOS_SANDBOX/mongodb-linux-x86_64-3.2.11/bin/mongod --bind_ip $LIBPROCESS_IP --port 27017 --dbpath $MESOS_SANDBOX/mongodb-replicaset --replSet {{MONGODB_REPLSET}}"
        uris:
          - "https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.2.11.tgz"

  init:
    count: {{INIT_COUNT}}
    tasks:
      replicaset:
        cpus: {{INIT_CPUS}}
        memory: {{INIT_MEM}}
        goal: RUNNING
        cmd: "chmod +x $MESOS_SANDBOX/init.sh && chmod +x $MESOS_SANDBOX/jq-linux64 && exec $MESOS_SANDBOX/init.sh"
        uris:
          - "https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.2.11.tgz"
          - "https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64"
        configurations:
          - template: "{{CONFIG_TEMPLATE_PATH}}/init.sh.mustache"
            dest: "init.sh"
        env:
          APP_NAME: {{INIT_APP_NAME}}
          ADD_DELAY: {{INIT_ADD_DELAY}}

plans:
  deploy:
    strategy: serial
    phases:
      mongodb-deploy:
        strategy: parallel
        pod: mongodb
      init-deploy:
        strategy: serial
        pod: init
