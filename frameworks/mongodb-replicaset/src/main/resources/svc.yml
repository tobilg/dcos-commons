name: "{{SERVICE_NAME}}"
principal: "{{SERVICE_NAME}}-principal"
zookeeper: master.mesos:2181
api-port: {{PORT0}}
pods:
  mongodb:
    count: {{MONGODB_COUNT}}
    resource-sets:
      mongodb-resources:
        cpus: {{MONGODB_CPUS}}
        memory: {{MONGODB_MEM}}
        ports:
          - name: "mongodb-port"
            port: {{MONGODB_PORT}}
            vip:
              prefix: "{{SERVICE_NAME}}"
              port: {{MONGODB_PORT}}
        volumes:
          - path: "mongodb-replicaset"
            type: ROOT
            size: {{MONGODB_DISK}}
    tasks:
      server:
        resource-set: mongodb-resources
        goal: RUNNING
        cmd: "env && exec $MESOS_SANDBOX/mongodb-linux-x86_64-{{MONGODB_VERSION}}/bin/mongod --bind_ip $LIBPROCESS_IP --port {{MONGODB_PORT}} --dbpath $MESOS_SANDBOX/mongodb-replicaset --replSet {{MONGODB_REPLSET}}"
        health-check:
          name: "mongodb-server-health-check"
          cmd: "curl --fail ${LIBPROCESS_IP}:{{MONGODB_PORT}} > /dev/null"
          interval: 30
          grace-period: 60
          max-consecutive-failures: 5
          delay: 5
          timeout: 5
        uris:
          - "https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-{{MONGODB_VERSION}}.tgz"

  init:
    count: {{INIT_COUNT}}
    tasks:
      replicaset:
        cpus: {{INIT_CPUS}}
        memory: {{INIT_MEM}}
        goal: FINISHED
        cmd: "chmod +x $MESOS_SANDBOX/init.sh && chmod +x $MESOS_SANDBOX/jq-linux64 && exec $MESOS_SANDBOX/init.sh"
        uris:
          - "https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-{{MONGODB_VERSION}}.tgz"
          - "https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64"
        configurations:
          - template: "{{CONFIG_TEMPLATE_PATH}}/init.sh.mustache"
            dest: "init.sh"
        env:
          SERVICE_NAME: {{SERVICE_NAME}}
          INITIATE_DELAY: {{INIT_INITIATE_DELAY}}
          ADD_DELAY: {{INIT_ADD_DELAY}}
          MONGODB_VERSION: {{MONGODB_VERSION}}
          MONGODB_PORT: {{MONGODB_PORT}}

plans:
  deploy:
    strategy: serial
    phases:
      mongodb-deploy:
        strategy: parallel
        pod: mongodb
      init-deploy:
        strategy: serial
        pod: init
